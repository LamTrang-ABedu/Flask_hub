{% extends 'index.html' %}
{% block title %}Tranh18 Reader{% endblock %}
{% block content %}
<script src="https://cdn.tailwindcss.com"></script>

<div id="reader-wrapper" class="w-full">
  <div class="text-center text-2xl font-bold mt-4">Thư viện truyện Tranh18</div>

  <!-- Điều hướng chương (luôn ở top khi đọc truyện) -->
  <div id="chapter-nav" class="hidden sm:flex justify-center items-center gap-2 p-2 mt-4 flex-wrap sticky top-0 bg-white z-10">
    <button onclick="prevChapter()" class="bg-gray-200 px-3 py-1 rounded">←</button>
    <select id="chapter-select" onchange="changeChapter(this.value)" class="border rounded px-2 py-1"></select>
    <button onclick="nextChapter()" class="bg-gray-200 px-3 py-1 rounded">→</button>
  </div>

  <!-- Danh sách truyện -->
  <div id="comic-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-6 gap-4 p-4"></div>

  <!-- Vùng đọc truyện -->
  <div id="reader" class="hidden">
    <div id="chapter-content" class="bg-black text-white w-full"></div>
    <button onclick="scrollToTop()" class="fixed bottom-4 right-4 bg-blue-600 text-white rounded-full px-4 py-2 shadow-md z-20">↑ Top</button>
  </div>
</div>

<script>
const R2_JSON_URL = 'https://r2.lam.io.vn/comics/tranh18.json';
let comics = [];
let currentComic = null;
let currentChapterIndex = 0;

function isMobile() {
  return window.innerWidth <= 768;
}

function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function backToList() {
  document.getElementById('reader').classList.add('hidden');
  document.getElementById('comic-list').classList.remove('hidden');
  document.getElementById('chapter-nav').classList.add('hidden');
  currentComic = null;
}

function renderComicList() {
  const container = document.getElementById('comic-list');
  container.innerHTML = '';
  comics.forEach((comic, idx) => {
    const div = document.createElement('div');
    div.className = 'cursor-pointer hover:opacity-90 transition border rounded overflow-hidden shadow';
    div.innerHTML = `
      <img src="${comic.image}" alt="${comic.name}" class="w-full h-[220px] object-cover"/>
      <div class="p-1 text-sm font-medium text-center line-clamp-2">${comic.name}</div>
    `;
    div.onclick = () => openComic(idx);
    container.appendChild(div);
  });
}

function openComic(index) {
  currentComic = comics[index];
  currentChapterIndex = 0;
  document.getElementById('comic-list').classList.add('hidden');
  document.getElementById('reader').classList.remove('hidden');
  document.getElementById('chapter-nav').classList.remove('hidden');
  renderChapterSelect();
  renderChapterContent();
}

function renderChapterSelect() {
  const select = document.getElementById('chapter-select');
  select.innerHTML = '';
  currentComic.chapters.forEach((chap, idx) => {
    const option = document.createElement('option');
    option.value = idx;
    option.textContent = `${currentComic.name} ${chap.name}`;
    if (idx === currentChapterIndex) option.selected = true;
    select.appendChild(option);
  });
}

function changeChapter(index) {
  currentChapterIndex = parseInt(index);
  renderChapterSelect();
  renderChapterContent();
}

function renderChapterContent() {
  const chap = currentComic.chapters[currentChapterIndex];
  const content = document.getElementById('chapter-content');
  content.innerHTML = '';
  chap.images.forEach(img => {
    const image = document.createElement('img');
    image.src = `/proxy-image?url=${encodeURIComponent(img)}`;
    image.className = isMobile() ? 'w-full mb-2' : 'mx-auto mb-2';
    image.loading = 'lazy';
    content.appendChild(image);
  });
}

function prevChapter() {
  if (currentChapterIndex > 0) {
    currentChapterIndex--;
    renderChapterSelect();
    renderChapterContent();
  }
}

function nextChapter() {
  if (currentChapterIndex < currentComic.chapters.length - 1) {
    currentChapterIndex++;
    renderChapterSelect();
    renderChapterContent();
  }
}

fetch(R2_JSON_URL)
  .then(res => res.json())
  .then(data => {
    comics = data.comics || [];
    renderComicList();
  })
  .catch(err => alert('Không thể tải dữ liệu truyện'));
</script>
{% endblock %}