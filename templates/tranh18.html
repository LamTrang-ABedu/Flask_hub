{% extends 'index.html' %}
{% block title %}Tranh18 Reader{% endblock %}
{% block content %}
<script src="https://cdn.tailwindcss.com"></script>

<style>
  #chapter-content {
    padding: 0 !important;
    margin: 0 !important;
  }

  #chapter-content img {
    width: 100% !important;
    height: auto;
  }

  @media (min-width: 768px) {
    #chapter-content img {
      width: auto !important;
      max-width: 100%;
    }
  }

  body {
    overflow-x: hidden;
  }
</style>

<div class="w-full">
  <h1 class="text-2xl font-bold mb-6 text-center">Thư viện truyện Tranh18</h1>
  <div id="comic-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-6 gap-4 px-2"></div>

  <div id="reader" class="hidden w-full">
    <!-- Điều hướng chương -->
    <div id="chapter-nav" class="flex justify-between items-center gap-2 p-2 bg-white sticky top-0 z-10">
      <button onclick="prevChapter()" class="px-3 py-1 bg-gray-200 rounded text-lg">←</button>
      <select id="chapter-select" onchange="onChapterSelect()" class="flex-1 p-1 border rounded text-center text-sm"></select>
      <button onclick="nextChapter()" class="px-3 py-1 bg-gray-200 rounded text-lg">→</button>
    </div>

    <div id="chapter-content" class="w-full overflow-auto bg-black text-white"></div>

    <!-- Back to top -->
    <button onclick="scrollToTop()" class="fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-full shadow-md">↑ Top</button>
  </div>
</div>

<script>
const R2_JSON_URL = 'https://r2.lam.io.vn/comics/tranh18.json';
let comics = [];
let currentComic = null;
let currentChapterIndex = 0;

function backToList() {
  document.getElementById('reader').classList.add('hidden');
  document.getElementById('comic-list').classList.remove('hidden');
  currentComic = null;
}

function renderComicList() {
  const container = document.getElementById('comic-list');
  container.innerHTML = '';
  comics.forEach((comic, idx) => {
    const div = document.createElement('div');
    div.className = 'cursor-pointer hover:opacity-90 transition border rounded overflow-hidden shadow';
    div.innerHTML = `
      <img src="${comic.image}" alt="${comic.name}" class="w-full h-[220px] object-cover"/>
      <div class="p-1 text-sm font-medium text-center line-clamp-2">${comic.name}</div>
    `;
    div.onclick = () => openComic(idx);
    container.appendChild(div);
  });
}

function openComic(index) {
  currentComic = comics[index];
  currentChapterIndex = 0;
  document.getElementById('comic-list').classList.add('hidden');
  document.getElementById('reader').classList.remove('hidden');
  renderChapterList();
  renderChapterContent();
}

function renderChapterList() {
  const select = document.getElementById('chapter-select');
  select.innerHTML = '';
  currentComic.chapters.forEach((chap, idx) => {
    const option = document.createElement('option');
    option.value = idx;
    option.textContent = chap.name;
    if (idx === currentChapterIndex) option.selected = true;
    select.appendChild(option);
  });
}

function renderChapterContent() {
  const chap = currentComic.chapters[currentChapterIndex];
  const title = document.getElementById('chapter-select');
  if (title) title.value = currentChapterIndex;

  const content = document.getElementById('chapter-content');
  content.innerHTML = '';
  chap.images.forEach(img => {
    const image = document.createElement('img');
    image.src = `/proxy-image?url=${encodeURIComponent(img)}`;
    image.loading = 'lazy';
    content.appendChild(image);
  });
}

function onChapterSelect() {
  const idx = parseInt(document.getElementById('chapter-select').value);
  if (!isNaN(idx)) {
    currentChapterIndex = idx;
    renderChapterList();
    renderChapterContent();
  }
}

function prevChapter() {
  if (currentChapterIndex > 0) {
    currentChapterIndex--;
    renderChapterList();
    renderChapterContent();
  }
}

function nextChapter() {
  if (currentChapterIndex < currentComic.chapters.length - 1) {
    currentChapterIndex++;
    renderChapterList();
    renderChapterContent();
  }
}

function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

fetch(R2_JSON_URL)
  .then(res => res.json())
  .then(data => {
    comics = data.comics || [];
    renderComicList();
  })
  .catch(err => alert('Không thể tải dữ liệu truyện'));
</script>
{% endblock %}