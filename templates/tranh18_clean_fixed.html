{% extends 'index.html' %}
{% block title %}Tranh18 Reader{% endblock %}
{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<style>
@media (max-width: 768px) {
  #chapter-sidebar {
    display: none;
  }

  #chapter-content {
    padding-top: 60px;
  }
}
</style>
<div class="p-4">
  <h1 class="text-2xl font-bold mb-6">Thư viện truyện Tranh18</h1>
  <div id="comic-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-6 gap-4"></div>

  <div id="reader" class="hidden">
    
<!-- Header điều hướng chương -->
<div id="chapter-header" class="sticky top-0 bg-white z-50 px-4 py-2 flex items-center justify-between shadow md:hidden">
  <button onclick="prevChapter()" class="px-2 py-1 bg-gray-200 rounded text-sm">← Trước</button>
  <select id="chapterSelect" onchange="jumpChapter()" class="px-2 py-1 border rounded text-sm">
    <!-- option chương sẽ được inject -->
  </select>
  <button onclick="nextChapter()" class="px-2 py-1 bg-gray-200 rounded text-sm">Sau →</button>
</div>

<div class="flex h-screen">
      <!-- Vùng hiển thị nội dung ảnh -->
      <div id="chapter-content" class="flex-1 overflow-auto bg-black text-white p-2">
        <!-- Ảnh chapter sẽ được inject vào đây bằng JS -->
      </div>

      <!-- Sidebar bên phải -->
      <div id="chapter-sidebar" class="w-[300px] bg-gray-100 p-4 flex flex-col">
        <!-- Điều hướng chương -->
        <div class="flex justify-between items-center mb-4">
          <button onclick="prevChapter()" class="px-2 py-1 bg-gray-300 rounded">← Chương trước</button>
          <div id="chapter-title" class="font-bold text-center text-sm flex-1">Chapter Title</div>
          <button onclick="nextChapter()" class="px-2 py-1 bg-gray-300 rounded">Chương sau →</button>
        </div>

        <!-- Danh sách chương -->
        <div class="overflow-y-auto border-t pt-2 flex-1">
          <div id="chapter-list" class="space-y-1">
            <!-- inject danh sách chương ở đây -->
          </div>
        </div>

        <!-- Quay lại danh sách truyện -->
        <button onclick="backToList()" class="mt-4 px-3 py-1 bg-gray-300 rounded">← Quay lại danh sách truyện</button>
      </div>
    </div>
  </div>
</div>

<script>
const R2_JSON_URL = 'https://r2.lam.io.vn/comics/tranh18.json';
let comics = [];
let currentComic = null;
let currentChapterIndex = 0;

function backToList() {
  document.getElementById('reader').classList.add('hidden');
  document.getElementById('comic-list').classList.remove('hidden');
  currentComic = null;
}

function renderComicList() {
  const container = document.getElementById('comic-list');
  container.innerHTML = '';
  comics.forEach((comic, idx) => {
    const div = document.createElement('div');
    div.className = 'cursor-pointer hover:opacity-90 transition border rounded overflow-hidden shadow';
    div.innerHTML = `
      <img src="${comic.image}" alt="${comic.name}" class="w-full h-[220px] object-cover"/>
      <div class="p-1 text-sm font-medium text-center line-clamp-2">${comic.name}</div>
    `;
    div.onclick = () => openComic(idx);
    container.appendChild(div);
  });
}

function openComic(index) {
  currentComic = comics[index];
  currentChapterIndex = 0;
  document.getElementById('comic-list').classList.add('hidden');
  document.getElementById('reader').classList.remove('hidden');
  renderChapterList();
  renderChapterContent();
}

function renderChapterList() {
  const select = document.getElementById('chapterSelect');
  if (select) {
    select.innerHTML = '';
    currentComic.chapters.forEach((chap, idx) => {
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = chap.name;
      if (idx === currentChapterIndex) opt.selected = true;
      select.appendChild(opt);
    });
  }
  const list = document.getElementById('chapter-list');
  list.innerHTML = '';
  currentComic.chapters.forEach((chap, idx) => {
    const div = document.createElement('div');
    div.className = `mb-1 p-1 cursor-pointer rounded ${idx === currentChapterIndex ? 'bg-blue-200 font-semibold' : 'hover:bg-gray-100'}`;
    div.textContent = chap.name;
    div.onclick = () => {
      currentChapterIndex = idx;
      renderChapterList();
      renderChapterContent();
    };
    list.appendChild(div);
  });
}


function renderChapterContent() {
  const chap = currentComic.chapters[currentChapterIndex];
  document.getElementById('chapter-title').textContent = chap.name;

  const content = document.getElementById('chapter-content');
  content.innerHTML = '';
  chap.images.forEach(img => {
    const image = document.createElement('img');
    image.src = `/proxy-image?url=${encodeURIComponent(img)}`;
    image.className = 'rounded shadow mb-2 mx-auto';
    image.loading = 'lazy';
    image.onerror = () => {
      image.onerror = null;
      image.src = img; // fallback to direct
    };
    content.appendChild(image);
  });
}
`;
    image.className = 'rounded shadow mb-2 mx-auto';
    image.loading = 'lazy';
    content.appendChild(image);
  });
}

function prevChapter() {
  if (currentChapterIndex > 0) {
    currentChapterIndex--;
    renderChapterList();
    renderChapterContent();
  }
}


function jumpChapter() {
  const idx = parseInt(document.getElementById('chapterSelect').value);
  if (!isNaN(idx)) {
    currentChapterIndex = idx;
    renderChapterList();
    renderChapterContent();
  }
}


function nextChapter() {
  if (currentChapterIndex < currentComic.chapters.length - 1) {
    currentChapterIndex++;
    renderChapterList();
    renderChapterContent();
  }
}

fetch(R2_JSON_URL)
  .then(res => res.json())
  .then(data => {
    comics = data.comics || [];
    renderComicList();
  })
  .catch(err => alert('Không thể tải dữ liệu truyện'));

<style>
@media (max-width: 768px) {
  #chapter-sidebar {
    display: none;
  }

  #chapter-content {
    padding-top: 60px;
  }
}
</style>
{% endblock %}
