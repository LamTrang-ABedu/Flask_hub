{% extends 'index.html' %}
{% block title %}Media Gallery{% endblock %}
{% block content %}

<h1>Media Gallery</h1>

<label for="sourceSelect">Select Source:</label>
<select id="sourceSelect">
  <option value="x_media.json">X (Twitter)</option>
  <option value="pornhub_media.json">Pornhub</option>
  <option value="xvideos_media.json">Xvideos</option>
</select>

<div id="gallery" class="grid"></div>

<div id="mediaPreview">
  <span id="closePreview">&times;</span>
  <div id="mediaPreviewContent"></div>
</div>

<style>
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
  }
  .media-item {
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
  }
  .media-item img {
    width: 100%;
    height: auto;
    display: block;
  }
  #mediaPreview {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  #mediaPreviewContent {
    max-width: 90vw;
    max-height: 90vh;
  }
  #closePreview {
    position: absolute;
    top: 20px;
    right: 20px;
    color: white;
    font-size: 24px;
    cursor: pointer;
  }
</style>

<script>
  async function loadGallery() {
    const source = document.getElementById('sourceSelect').value;
    const gallery = document.getElementById('gallery');
    gallery.innerHTML = 'Loading...';

    try {
      const res = await fetch(`https://r2.lam.io.vn/MEDIA/${source}`);
      const items = await res.json();
      gallery.innerHTML = '';

      items.forEach(item => {
        // Chuẩn hóa định dạng item
        if (!item.type) {
          if (item.video && item.thumb) {
            item.type = "video";
            item.post_url = item.video;
            item.thumbnail = item.thumb;
          } else {
            item.type = "image";  // fallback nếu chỉ có ảnh
            item.url = item.url || item.thumb;
          }
        }

        const div = document.createElement('div');
        div.className = 'media-item';

        if (item.type === 'image') {
          const img = document.createElement('img');
          img.src = item.url;
          img.alt = item.title || 'image';
          div.appendChild(img);
        } else if (item.type === 'video') {
          const thumb = document.createElement('img');
          thumb.src = item.thumbnail;
          thumb.alt = item.title || 'video';
          div.appendChild(thumb);
        }

        div.onclick = () => showPreview(item);
        gallery.appendChild(div);
      });
    } catch (err) {
      gallery.innerHTML = 'Failed to load.';
      console.error(err);
    }
  }

  function showPreview(item) {
    const preview = document.getElementById('mediaPreview');
    const content = document.getElementById('mediaPreviewContent');
    content.innerHTML = '';

    if (item.type === 'image') {
      const url = item.url.split('&')[0];
      const img = document.createElement('img');
      img.src = url;
      img.style.maxWidth = '100%';
      img.style.maxHeight = '100%';
      content.appendChild(img);
    } else if (item.type === "video") {
  fetch(`/api/universal-download?url=${encodeURIComponent(item.post_url)}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === 'ok' && data.media.length > 0) {
        const realUrl = data.media[0].url;
        const video = document.createElement('video');
        video.controls = true;
        video.autoplay = true;
        video.src = realUrl;
        video.style.maxWidth = '100%';
        video.style.maxHeight = '100%';
        content.appendChild(video);
      } else {
        content.innerHTML = '<div style="color:red">Failed to load video</div>';
      }
    })
    .catch(err => {
      console.error(err);
      content.innerHTML = '<div style="color:red">Error loading video</div>';
    });
}

    preview.style.display = 'flex';
  }

  document.getElementById('closePreview').onclick = () => {
    document.getElementById('mediaPreview').style.display = 'none';
    document.getElementById('mediaPreviewContent').innerHTML = '';
  };

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('sourceSelect').onchange = loadGallery;
    loadGallery();
  });
</script>

{% endblock %}
